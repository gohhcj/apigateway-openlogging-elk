{
  "fields": {
    "gatewayName": "API-Gateway 1",
    "gatewayRegion": "APAC"
  },
  "codec": "json_lines",
  "testcases": [
    {
      "description": "Header events should be dropped, hence we don't expect an event",
      "input": [
        "{\"type\":\"header\", \"logCreationTime\":\"2020-08-26 12:15:00.010\", \"hostname\":\"api-env\", \"domainId\":\"ed992442-c363-4d36-963a-9e6314b0f421\", \"groupId\":\"group-2\", \"groupName\":\"QuickStart Group\", \"serviceId\":\"instance-1\", \"serviceName\":\"QuickStart Server\", \"version\":\"v7.7.0-Internal\"}"
      ],
      "expected": [ ]
    },
    {
      "description": "For now, we skip transaction events - Might be changed later",
      "input": [
        "{\"type\":\"transaction\", \"time\":1598469300007, \"path\":null, \"protocol\":null, \"protocolSrc\":null, \"duration\":2, \"status\":\"success\", \"serviceContexts\":[], \"customMsgAtts\":{}, \"correlationId\":\"b4b4465f0093bdc9ba91150e\", \"legs\":[]}"
      ],
      "expected": [ ]
    },
    {
      "description": "System events should produce an event",
      "input": [
        "{\"type\":\"system\", \"time\":1598469315360, \"diskUsed\":88, \"instCpu\":3, \"sysCpu\":13, \"instMem\":2269044, \"sysMem\":15677168, \"sysMemTotal\":16266828}"
      ],
      "expected": [
        {
          "@timestamp": "2020-08-26T19:15:15.360Z",
          "type": "system",
          "sysMem": "15677168000",
          "diskUsed": 88,
          "instMem": "2269044000",
          "sysCpu": 13,
          "sysMemTotal": "16266828000",
          "instCpu": 3,
          "processInfo": {
            "gatewayName": "API-Gateway 1", 
            "gatewayRegion": "APAC"
          }
        }
      ]
    },
    {
      "description": "Alert events should produce an event",
      "input": [
        "{\"type\":\"alert\", \"time\":1598537495841, \"alertType\":\"AlertMessage\", \"level\":3, \"id\":\"-749bad62:174302050ef:-7fff\", \"srcId\":\"api-env:instance-1\", \"msgId\":\"Id-17bf475fb303f8664492b7ba\", \"defaultMsg\":\"API Manager: Frontend API weatherbit with ID 65182d09-88de-49c6-a303-5dcf64df71c2 has been unpublished.\", \"clientIP\":\"192.168.233.1\", \"policy\":\"Send Alert\", \"filter\":\"Send API Manager Alert\"}"
      ],
      "expected": [
        {
          "@timestamp": "2020-08-27T14:11:35.841Z",
          "type": "alert",
          "alertType": "AlertMessage",
          "level": 3,
          "srcId": "api-env:instance-1",
          "msgId": "Id-17bf475fb303f8664492b7ba",
          "defaultMsg": "API Manager: Frontend API weatherbit with ID 65182d09-88de-49c6-a303-5dcf64df71c2 has been unpublished.",
          "clientIP": "192.168.233.1",
          "policy": "Send Alert",
          "filter": "Send API Manager Alert",
          "processInfo": {
            "gatewayName": "API-Gateway 1", 
            "gatewayRegion": "APAC"
          }
        }
      ]
    }, 
    {
      "description": "If transaction event contains a transactionId we expect an event - Used to update the Traffic-Summary index",
      "input": [
        "{\"type\":\"transaction\", \"time\":1613481656889, \"path\":\"/petstore/v2/pet/findByStatus\", \"protocol\":\"https\", \"protocolSrc\":\"8065\", \"duration\":59, \"status\":\"failure\", \"serviceContexts\":[{\"service\":\"Petstore\", \"monitor\":true, \"client\":null, \"org\":null, \"app\":null, \"method\":\"findPetsByStatus\", \"status\":\"success\", \"duration\":1}], \"customMsgAtts\":{\"transactionId\":\"+CHzeZD9TOX+xKEQ3HrqNejxT4M=\"}, \"correlationId\":\"b8c62b607f4ef78b70ae798d\", \"legs\":[{\"uri\":\"/petstore/v2/pet/findByStatus\", \"status\":500, \"statustext\":\"Internal Server Error\", \"method\":\"GET\", \"vhost\":null, \"wafStatus\":0, \"bytesSent\":735, \"bytesReceived\":139, \"remoteName\":\"127.0.0.1\", \"remoteAddr\":\"127.0.0.1\", \"localAddr\":\"127.0.0.1\", \"remotePort\":\"50968\", \"localPort\":\"8065\", \"sslsubject\":null, \"leg\":0, \"timestamp\":1613481656830, \"duration\":59, \"serviceName\":\"Petstore\", \"subject\":\"3a81bc24-f5fb-4682-9ee2-86e792ac2e4e\", \"operation\":\"findPetsByStatus\", \"type\":\"http\", \"finalStatus\":\"Fail\"}, {\"uri\":\"/api/v2/pet/findByStatus\", \"status\":403, \"statustext\":\"Forbidden\", \"method\":\"GET\", \"vhost\":null, \"wafStatus\":0, \"bytesSent\":268, \"bytesReceived\":821, \"remoteName\":\"localhost\", \"remoteAddr\":\"127.0.0.1\", \"localAddr\":\"127.0.0.1\", \"remotePort\":\"8280\", \"localPort\":\"34952\", \"sslsubject\":null, \"leg\":1, \"timestamp\":1613481656831, \"duration\":57, \"serviceName\":\"Petstore\", \"subject\":\"3a81bc24-f5fb-4682-9ee2-86e792ac2e4e\", \"operation\":\"findPetsByStatus\", \"type\":\"http\", \"finalStatus\":null}]}"
      ],
      "expected": [
        {
          "correlationId": "b8c62b607f4ef78b70ae798d",
          "transactionId": "+CHzeZD9TOX+xKEQ3HrqNejxT4M="
        }
      ]
    }
  ]
}
